angular.module("comments",["comments.service"]).controller("CommentsCtrl",["$scope","LocalStorage","$window",function(e,n,t){"use strict";function i(){if(c){var n=c.indexes,t=e.comments[n[0]].replies,i=n.length-1;if(0===i)e.comments[c.indexes[0]]=c.comment;else{for(var o=1;i>o;o++)t=t[n[o]].replies;t[n[i]]=c.comment}c=null}}function o(e){for(var n=[];e;)e.hasOwnProperty("comment")&&n.unshift(e.$index),e=e.$parent;return n}e.comments=n.load()||[],e.activeComment=null;var m,c;t.addEventListener("beforeunload",function(){e.cancelEditing(),n.save(e.comments)}),e.addComment=function(){e.cancelEditing(),e.activeComment=new Comment("","",!0)},e.saveComment=function(e,n,t){n.editable=!1,n.date=new Date,e[t]=n},e.saveNewComment=function(){e.saveComment(e.comments,e.activeComment,e.comments.length),e.cancelAdding()},e.reply=function(n){e.cancelAdding(),e.cancelEditing(),m=n,n.replies[n.replies.length]=new Comment("@"+n.author+" ","",!0)},e.cancelAdding=function(){e.activeComment=null},e.cancelEditing=function(){m&&m.replies.length>0&&m.replies[m.replies.length-1].editable&&m.replies.pop(),i()},e.deleteComment=function(n,t){if(confirm("Вы уверены, что хотите удалить комментарий?")){var i=n.$parent.comment?n.$parent.comment.replies:e.comments;i.splice(t,1)}},e.edit=function(n,t){e.cancelAdding(),c={indexes:o(t),comment:angular.extend({},n)},n.editable=!0}}]);var Comment=function(e,n,t){this.text=e,this.author=n,this.text=e,this.editable=t,this.collapsed=!1,this.date=null,this.replies=[]};